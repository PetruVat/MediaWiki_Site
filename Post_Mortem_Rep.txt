
Post Mortem: Восстановление работоспособности веб-сервера и исправление конфигурации MediaWiki

Дата инцидента: 6 января 2025 года
Дата отчета: 7 января 2025 года
Составил: Vatov Petru

---

Описание инцидента:
Проблема началась с невозможности подключения к серверу MediaWiki из-за ошибки конфигурации и отсутствия свободного места на диске. 
На этапе диагностики выяснилось, что логи веб-сервера Apache занимали значительный объем памяти, 
а файл конфигурации LocalSettings.php был пустым.

---

Причины инцидента:
1. В ходе диагностики было выявлено отсутствие свободного пространства на основном разделе диска:
   Логи веб-сервера Apache (access_log) достигли 7 ГБ, что привело к полной заполняемости диска.
2. Некорректная конфигурация MediaWiki:
   Переменная $wgServer в файле LocalSettings.php содержала неправильный IP-адрес, что привело к ошибке загрузки сайта.

---

Шаги по устранению и результаты:

1. Диагностика проблемы с подключением:
   - Ошибка SSH из-за слишком открытых прав на приватный ключ была устранена командой:
     chmod 600 /home/igor/ich/ich.pem
   - Успешное подключение позволило начать диагностику на сервере.

2. Проверка дискового пространства:
   - Команда df -h показала, что на основном разделе диска отсутствует место.
   - Найден крупный файл логов:
     sudo find / -type f -size +1G
     Лог Apache /var/log/httpd/access_log занимал 7 ГБ.

3. Очистка логов:
   - Лог был очищен без удаления файла:
     sudo truncate -s 0 /var/log/httpd/access_log

4. Исправление конфигурации MediaWiki:
   - Файл LocalSettings.php в /var/www/html/mediawiki/ оказался пустым. Он был заменен содержимым из файла LocalSettings (5).php.
   - Исправлен IP-адрес в $wgServer:
     $wgServer = "https://3.79.39.74";

5. Создание и настройка скрипта для управления логами:
   - Написан скрипт log_backup.sh для:
     - Архивирования логов.
     - Очистки текущих логов.
     - Удаления архивов старше 3 дней.
   - Скрипт добавлен в crontab:
     0 0 * * * /home/ec2-user/log_backup.sh

6. Удаление лишних задач из crontab:
   - Старый крон для ежеминутного создания архивов логов был закомментирован.

7. Проверка и перезапуск Apache:
   - Состояние Apache проверено:
     sudo service httpd status
   - Сервер перезапущен:
     sudo systemctl restart httpd

---

Результаты:
- Веб-сервер Apache и MediaWiki восстановили свою работоспособность.
- Проблема с нехваткой места на диске устранена.
- Ошибки в конфигурации MediaWiki исправлены.
- Логи теперь управляются корректно благодаря созданному скрипту.

---

Рекомендации:
1. Настроить систему мониторинга с оповещениями при превышении 80% использования диска.

2. Убедиться, что задания в crontab выполняются с разумной периодичностью.

3. Автоматизировать архивирование логов и их очистку, чтобы избежать накопления больших файлов.

4. Вести журнал изменений файлов конфигурации, чтобы в случае проблем быстро восстанавливать настройки.

---

Заключение:
Проблемы, возникшие в результате неправильной конфигурации и заполнения дискового пространства, были успешно решены. 
Реализованные меры предотвращают повторение подобных ситуаций, обеспечивая стабильную работу веб-сервиса.
